set-option -g default-terminal 'screen-256color'
set-option -g terminal-overrides ',xterm-256color:RGB'
set -g allow-passthrough on
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM

unbind C-b
set -g prefix `
bind ` send-prefix
set -g mouse on
set -g base-index 1
set -g set-clipboard on          # use system clipboard
set -g status-position top       # macOS / darwin style
set -g detach-on-destroy off     # don't exit from tmux when closing a session
set -g escape-time 0             # zero-out escape time delay
set -g history-limit 1000000     # increase history size (from 2,000)
set -g renumber-windows on       # renumber all windows when any window is closed
set -g status-interval 2         # Refresh the status line every X seconds
set -g repeat-time 2000          # 2s repeat window for -r bindings

bind r command-prompt "rename-window %%"
bind R source-file ~/.config/tmux/tmux.conf \; display " Config reloaded!"
bind S command-prompt "rename-session %%"

# Better pane splitting (and keep current path)
bind | split-window -h -c "#{pane_current_path}"
bind _ split-window -v -c "#{pane_current_path}"

# Pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R
bind w list-windows
bind x kill-pane

# Pane resizing
bind -r , resize-pane -L 15
bind -r . resize-pane -R 15
bind -r - resize-pane -D 5
bind -r = resize-pane -U 5
bind Z resize-pane -Z

# Window navigation
bind -r H previous-window
bind -r L next-window
bind c new-window -c "#{pane_current_path}"
bind X kill-window
# Random name generator (repeatable, deletes previous if within 6 seconds)
bind -r N run-shell '\
  len=$(tmux show-option -gqv @random_name_len); \
  len=${len:-0}; \
  stored_time=$(tmux show-option -gqv @random_name_time); \
  stored_time=${stored_time:-0}; \
  now=$(date +%s); \
  if [ "$len" -gt 0 ] && [ $((now - stored_time)) -le 6 ]; then \
    tmux send-keys $(printf "BSpace %.0s" $(seq 1 $len)); \
  fi; \
  name=$(~/.scripts/random-name.sh); \
  tmux send-keys "$name"; \
  tmux set-option -g @random_name_len ${#name}; \
  tmux set-option -g @random_name_time $(date +%s)'

# Copy mode vi bindings (screen-like behavior)
bind -T copy-mode-vi v send-keys -X begin-selection                    # v: begin selection
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel          # y: copy and exit
bind -T copy-mode-vi r send-keys -X rectangle-toggle                   # r: toggle rectangle mode
bind -T copy-mode-vi Escape send-keys -X cancel                        # Esc: exit copy mode
bind -T copy-mode-vi / send-keys -X search-forward                     # /: search forward
bind -T copy-mode-vi ? send-keys -X search-backward                    # ?: search backward
bind -T copy-mode-vi n send-keys -X search-again                       # n: next search result
bind -T copy-mode-vi N send-keys -X search-reverse                     # N: previous search result
bind -T copy-mode-vi h send-keys -X cursor-left                        # h: move left
bind -T copy-mode-vi j send-keys -X cursor-down                        # j: move down
bind -T copy-mode-vi k send-keys -X cursor-up                          # k: move up
bind -T copy-mode-vi l send-keys -X cursor-right                       # l: move right
bind v copy-mode                                                           # prefix + v: enter copy mode
bind -T copy-mode-vi V send-keys -X select-line                           # V: visual-line mode
bind -T copy-mode-vi Y send-keys -X start-of-line \; send-keys -X begin-selection \; send-keys -X end-of-line \; send-keys -X copy-selection-and-cancel  # Y: yank whole line

# Source flexoki theme
source-file ~/.config/tmux/flexoki-dark.tmuxtheme

# Custom flexoki theme elements
set -g window-status-current-format "#[fg=#{FLEXOKI_PURPLE},bold] [#I] #W"

# List of plugins
set -g @plugin 'omerxx/tmux-sessionx'
set -g @plugin 'omerxx/tmux-floax'
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'sjdonado/tmux-workspace-usage'
set -g @plugin 'olimorris/tmux-pomodoro-plus'

set -g @floax-width '80%'
set -g @floax-height '80%'
set -g @floax-border-color '#8b7ec8'  # FLEXOKI_PURPLE
set -g @floax-text-color '#4385be'    # FLEXOKI_BLUE
set -g @floax-bind 'F'
set -g @floax-change-path 'true'

# sessionx config
set -g @sessionx-bind 'O'
set -g @sessionx-window-height '80%'
set -g @sessionx-window-width '75%'
set -g @sessionx-zoxide-mode 'on'
set -g @sessionx-filter-current 'true'
set -g @sessionx-preview-location 'top'
set -g @sessionx-layout 'reverse'
set -g @sessionx-filtered-sessions 'scratch'
set -g @sessionx-pointer '>'
set -g @sessionx-additional-options '--color=bg+:#282726,bg:#1c1b1a,spinner:#cecdc3,hl:#d14d41,fg:#cecdc3,header:#d14d41,info:#8b7ec8,pointer:#cecdc3,marker:#cecdc3,fg+:#cecdc3,prompt:#8b7ec8,hl+:#d14d41'

# Popup apps
bind G display-popup -E -w 95% -h 95% -d "#{pane_current_path}" "lazygit --use-config-file=$HOME/.config/lazygit/config.yml"
bind V display-popup -E -w 95% -h 95% -d "#{pane_current_path}" "nvim"
bind Y display-popup -E -w 95% -h 95% -d "#{pane_current_path}" "yazi"
bind K run-shell "~/.scripts/keyboard-clean"
# Prompt enhancer (clipboard → claude → replace input)
bind E run-shell -b '~/.scripts/prompt-enhance.sh'

# Pomodoro config
set -g @pomodoro_toggle 'p'          # prefix + p to start/pause
set -g @pomodoro_cancel 'P'          # prefix + P to cancel
set -g @pomodoro_skip '+'            # prefix + + to skip
set -g @pomodoro_granularity 'on'    # show MM:SS format
set -g @pomodoro_notifications 'off' # desktop notifications

set -g @pomodoro_mins 25                       # The duration of the Pomodoro
set -g @pomodoro_break_mins 5                  # The duration of the break after the Pomodoro completes
set -g @pomodoro_intervals 4                   # The number of intervals before a longer break is started
set -g @pomodoro_long_break_mins 25            # The duration of the long break

set -g @pomodoro_on "#[fg=#{FLEXOKI_RED}]􀐯  "                      # The formatted output when the Pomodoro is running
set -g @pomodoro_complete "#[fg=#{FLEXOKI_GREEN}]􀁣  "                # The formatted output when the break is running
set -g @pomodoro_pause "#[fg=#{FLEXOKI_YELLOW}]􀊘  "                   # The formatted output when the Pomodoro/break is paused
set -g @pomodoro_prompt_break "#[fg=#{FLEXOKI_CYAN}]􁚞  break?"      # The formatted output when waiting to start a break
set -g @pomodoro_prompt_pomodoro "#[fg=#{FLEXOKI_MAGENTA}]􀊕  start?"   # The formatted output when waiting to start a Pomodoro
set -g @pomodoro_prompt_pomodoro '#[fg=#{FLEXOKI_BLUE}]􀁜  again?'   # The formatted output when completing a cycle

# Workspace usage config
set -g @workspace_usage_processes 'tmux|nvim|node|python|mason|lazygit|claude|cargo|go|deno|bun|docker'
set -g @workspace_usage_mem 'on'
set -g @workspace_usage_cpu 'on'

# Status line
set -g status-left-length 50
set -g status-left '#[fg=#{FLEXOKI_BG},bg=black]#[fg=#{FLEXOKI_TX},bg=default,bold]􀣺  #h | #S'
set -g status-right '#[fg=#{FLEXOKI_TX}]􀫦  #{workspace_usage} 􀫥  | #(out=$(~/.config/tmux/plugins/tmux-pomodoro-plus/scripts/pomodoro.sh); [ -n "$out" ] && echo "$out" || echo "#[fg=#{FLEXOKI_TX_3}]􀁜  begin?")#[fg=#{FLEXOKI_BG},bg=black]'

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.config/tmux/plugins/tpm/tpm'
